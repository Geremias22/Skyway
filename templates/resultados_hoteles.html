<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üè® Hoteles en BCN</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    .hidden { display: none; }
    .detalles { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
    .photo-gallery img { max-width: 120px; margin: 2px; }
  </style>
</head>
<body>
  <nav style="background:#eef; padding:10px; margin-bottom:20px;">
    ‚úÖ {{ total_hotels }} hoteles encontrados en BCN<br>
    ‚úÖ Ofertas recibidas: {{ total_offers }}<br>
    Fechas: {{ check_in }} ‚Üí {{ check_out }}
  </nav>

  <ul>
  {% for h in hoteles if h.num_offers > 0 %}
    <li>
      <strong>{{ h.nombre }}</strong> ‚Äî Ofertas: {{ h.num_offers }}
      <button 
        class="btn-gm" 
        data-hotel-id="{{ h.hotelId }}" 
        onclick="toggleDetails(this)"
      >M√°s detalles</button>

      <div id="detalles-{{ h.hotelId }}" class="hidden detalles">
        {# ‚Äî‚Äî‚Äî secci√≥n Amadeus ‚Äî‚Äî‚Äî #}
        {% for o in h.offers %}
          <h4>Oferta {{ loop.index }}</h4>
          <p><strong>Precio:</strong> {{ o.precio }} {{ o.moneda }}</p>
          <p><strong>Fechas:</strong> {{ o.checkin }} ‚Üí {{ o.checkout }}</p>
          <p><strong>Habitaciones:</strong> {{ o.room_quantity }}</p>
          <p><strong>Categor√≠a:</strong> {{ o.room_category }} ({{ o.beds }} camas)</p>
          <p><strong>R√©gimen:</strong> {{ o.board_type }}, c√≥digo tarifa {{ o.rate_code }}</p>
          <p><strong>Impuestos:</strong></p>
          <ul>
            {% for tax in o.taxes %}
              <li>
                {{ tax.code }}: {{ tax.amount or tax.percentage }}
                {{ tax.currency or "" }}
                {% if not tax.included %}(no incluido){% endif %}
              </li>
            {% endfor %}
          </ul>
          <p><strong>Pol√≠ticas de cancelaci√≥n:</strong></p>
          <ul>
            {% for pol in o.cancellation_policies %}
              <li>
                {% if pol.description %}
                  {{ pol.description.text }}
                {% elif pol.deadline %}
                  Hasta {{ pol.deadline }} ({{ pol.policyType }})
                {% else %}
                  {{ pol.policyType }}
                {% endif %}
              </li>
            {% endfor %}
          </ul>
          <p><strong>Pago:</strong> {{ o.payment_type }}</p>
          <p><strong>Descripci√≥n:</strong> {{ o.description }}</p>
          <hr>
        {% endfor %}

        {# ‚Äî‚Äî‚Äî secci√≥n Google Places ‚Äî‚Äî‚Äî #}
        <div class="google-info" id="gm-{{ h.hotelId }}">
          <p>Cargando info de Google‚Ä¶</p>
        </div>
      </div>
    </li>
  {% else %}
    <li><em>No hay hoteles con ofertas disponibles.</em></li>
  {% endfor %}
  </ul>

  <script>
  function toggleDetails(btn) {
    const hotelId = btn.dataset.hotelId;
    const cont = document.getElementById('detalles-' + hotelId);
    cont.classList.toggle('hidden');

    const gmDiv = document.getElementById('gm-' + hotelId);
    // Si ya hemos cargado la info, no volvemos a pedirla
    if (gmDiv.dataset.loaded) return;

    fetch(`/hotel/${hotelId}/gm-info`)
      .then(r => {
        if (r.status === 204) throw 'No data';
        if (!r.ok)    throw 'Error';
        return r.json();
      })
      .then(data => {
        gmDiv.dataset.loaded = '1';
        gmDiv.innerHTML = '';

        if (data.address) {
          const p = document.createElement('p');
          p.innerHTML = `<strong>Direcci√≥n exacta:</strong> ${data.address}`;
          gmDiv.appendChild(p);
        }
        if (data.rating) {
          const p = document.createElement('p');
          p.innerHTML = `<strong>Valoraci√≥n Google:</strong> ‚≠ê ${data.rating}`;
          gmDiv.appendChild(p);
        }
        if (data.photos && data.photos.length) {
          const gallery = document.createElement('div');
          gallery.classList.add('photo-gallery');
          data.photos.forEach(u => {
            const img = document.createElement('img');
            img.src = u;
            img.alt = `Foto de ${btn.previousElementSibling.textContent}`;
            gallery.appendChild(img);
          });
          gmDiv.appendChild(gallery);
        }
        if (!data.address && !data.rating && (!data.photos || !data.photos.length)) {
          gmDiv.innerHTML = '<em>No hay datos de Google disponibles.</em>';
        }
      })
      .catch(_ => {
        gmDiv.innerHTML = '<em>Error al cargar info de Google.</em>';
      });
  }
  </script>
</body>
</html>
